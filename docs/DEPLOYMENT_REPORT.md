# Отчет о развертывании ALVS_project на сервере

**Дата развертывания:** [ДД.ММ.ГГГГ]  
**Сервер:** root@144.31.87.154  
**Версия проекта:** [версия/коммит]  
**Ответственный:** [Имя]

---

## 1. Информация о сервере

### Системная информация

```bash
# Заполните после выполнения команд на сервере
```

- **ОС:** [например, Ubuntu 22.04 LTS]
- **Архитектура:** [например, x86_64]
- **Ядро:** [например, Linux 5.15.0]
- **Общий объем диска:** [например, 20 GB]
- **Свободное место до развертывания:** [например, 5 GB]
- **Свободное место после развертывания:** [например, 4.2 GB]

### Установленное ПО

- **Docker версия:** [например, 24.0.5]
- **Docker Compose версия:** [например, 2.20.0]
- **PostgreSQL версия:** [например, 14.9]
- **Python версия:** [например, 3.10.12] (если установлен)
- **Git версия:** [например, 2.34.1]

---

## 2. Выполненные оптимизации

### Использованные утилиты сервера

- [x] **PostgreSQL на хосте** - используется внешний PostgreSQL вместо контейнера
- [ ] **Python на хосте** - [опционально, если использовался]
- [ ] **Другие утилиты** - [укажите, если использовались]

### Удаленные компоненты

- [x] **Контейнер PostgreSQL** - экономия ~200-300 MB образа + данные БД
- [x] **Контейнер Prometheus** - экономия ~100-150 MB
- [x] **Контейнер Grafana** - экономия ~200-300 MB
- [x] **Контейнер Loki** - экономия ~50-100 MB
- [x] **Контейнер Promtail** - экономия ~50-100 MB

### Экономия места

- **Размер образа приложения:** [например, 250 MB]
- **Экономия от удаления контейнеров:** [например, 600-1000 MB]
- **Общая экономия:** [например, ~800 MB]

---

## 3. Конфигурация развертывания

### Настройки PostgreSQL

- **Хост:** [например, host.docker.internal или IP адрес]
- **Порт:** [например, 5432]
- **База данных:** [например, test_db]
- **Пользователь:** [например, postgres]
- **Метод доступа:** [например, через host.docker.internal или network_mode: host]

### Настройки приложения

- **Порт приложения:** [например, 5000]
- **Сеть Docker:** [например, bridge или host]
- **Volumes:** [укажите используемые volumes]

### Файлы конфигурации

- **docker-compose.yml:** используется для базовой конфигурации
- **docker-compose.prod.yml:** используется для production override
- **.env файл:** расположен в `config/docker/.env`

---

## 4. Процесс развертывания

### Шаг 1: Подготовка сервера

```bash
# Выполненные команды
```

- [x] Проверка Docker
- [x] Проверка Docker Compose
- [x] Проверка PostgreSQL
- [x] Проверка свободного места
- [x] Настройка доступа PostgreSQL для Docker

### Шаг 2: Клонирование репозитория

```bash
# Команда клонирования
git clone https://github.com/mmiikkkeee013248/ALVS_project.git
cd ALVS_project
```

- **Ветка:** [например, main]
- **Коммит:** [например, abc123def]

### Шаг 3: Применение локальных изменений

- [x] Создан файл `config/docker/.env` из примера
- [x] Настроены параметры подключения к PostgreSQL
- [x] Проверена конфигурация `docker-compose.prod.yml`

### Шаг 4: Сборка и запуск

```bash
# Команды сборки и запуска (используйте правильную команду для вашей версии)
cd config/docker
docker compose -f docker-compose.yml -f docker-compose.prod.yml build webapp
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d webapp
# или для V1:
# docker-compose -f docker-compose.yml -f docker-compose.prod.yml build webapp
# docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d webapp
```

**Время сборки:** [например, 2 минуты]  
**Время запуска:** [например, 10 секунд]

---

## 5. Проверка работоспособности

### Статус контейнеров

```bash
# Вывод docker-compose ps
```

- [x] Контейнер `flask-app` запущен
- [x] Контейнер здоров (healthcheck пройден)
- [x] Нет ошибок в логах

### Проверка доступности

- [x] Приложение доступно на http://[IP]:5000
- [x] Подключение к PostgreSQL работает
- [x] Создание таблиц прошло успешно
- [x] CRUD операции работают

### Тестирование функциональности

- [x] Добавление контакта
- [x] Редактирование контакта
- [x] Удаление контакта
- [x] Просмотр списка контактов

---

## 6. Использованные команды

### Полезные команды для управления

```bash
# Просмотр логов (используйте правильную команду для вашей версии)
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f webapp
# или
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f webapp

# Перезапуск
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart webapp

# Остановка
docker compose -f docker-compose.yml -f docker-compose.prod.yml down

# Обновление
git pull
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build webapp
```

---

## 7. Возникшие проблемы и решения

### Проблема 1: Ошибка при клонировании репозитория

**Описание:** `git clone` не работал с URL `github-account1.com` - не удавалось разрешить хост.

**Решение:** Использован правильный HTTPS URL: `https://github.com/mmiikkkeee013248/ALVS_project.git`. Для приватных репозиториев рекомендуется использовать Personal Access Token.

---

### Проблема 2: Docker Compose V2 не определялся скриптом

**Описание:** Скрипт `deploy-server.sh` не находил `docker-compose`, хотя `docker compose` (V2) был установлен.

**Решение:** Добавлена автоматическая детекция версии Docker Compose (V1 или V2) с использованием переменной `DOCKER_COMPOSE_CMD` для всех команд.

---

### Проблема 3: Контейнер PostgreSQL пытался запуститься в production

**Описание:** При использовании `-f docker-compose.yml -f docker-compose.prod.yml` Docker Compose объединял файлы, и контейнер PostgreSQL все равно запускался, конфликтуя с системным PostgreSQL на порту 5432.

**Решение:** Создан полностью независимый `docker-compose.prod.yml`, который не наследует базовый файл. Скрипт теперь использует только production файл без базового.

---

### Проблема 4: Порт 5000 уже занят

**Описание:** Ошибка `failed to bind host port 0.0.0.0:5000/tcp: address already in use` при запуске контейнера.

**Решение:** Добавлена проверка и автоматическое освобождение порта 5000 в скрипте развертывания (поддержка `lsof`, `netstat`, `ss`). Также добавлен флаг `--remove-orphans` для удаления старых контейнеров.

---

### Проблема 5: Приложение возвращает пустую страницу

**Описание:** Приложение запускалось, но возвращало пустую страницу при обращении к `http://144.31.87.154:5000`.

**Решение:** Исправлена команда запуска Gunicorn в Dockerfile: изменено с `app.web_app:create_app()` на `app.web_app:app`. Добавлена переменная `app = create_app()` в `web_app.py` для корректной работы с Gunicorn.

---

### Проблема 6: Grafana не видит Prometheus

**Описание:** Grafana работает, но не может подключиться к Prometheus, так как Prometheus не включен в production конфигурацию.

**Решение:** Prometheus можно запустить отдельно командой `docker run` или добавить в production конфигурацию при необходимости. В Grafana настроить Data Source с URL `http://144.31.87.154:9090` (IP адрес сервера).

---

## 8. Рекомендации

### Безопасность

- [ ] Изменен пароль PostgreSQL на надежный
- [ ] Настроен firewall для ограничения доступа
- [ ] Ограничен доступ к PostgreSQL только необходимым IP
- [ ] Настроены регулярные обновления

### Мониторинг

- [ ] Настроен мониторинг (если нужен)
- [ ] Настроены алерты
- [ ] Настроено логирование

### Резервное копирование

- [ ] Настроено резервное копирование базы данных
- [ ] Настроено резервное копирование конфигурации
- [ ] Проверена процедура восстановления

---

## 9. Дополнительная информация

### Ссылки на документацию

- [Документация по развертыванию](DEPLOYMENT_SERVER.md)
- [Docker документация](DOCKER.md)
- [Основная документация проекта](../README.md)

### Контакты

- **Поддержка:** [контакты]
- **Документация:** [ссылки]

---

## 10. Заключение

**Статус развертывания:** [Успешно / Частично / Неудачно]

**Итоги:**
- Развертывание выполнено с использованием внешних утилит сервера
- Экономия дискового пространства: [X] MB
- Приложение работает стабильно
- Все проверки пройдены

**Дата заполнения отчета:** [ДД.ММ.ГГГГ]  
**Подпись:** ___________________
