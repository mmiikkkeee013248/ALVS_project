# Основы работы Ansible

## Что такое Ansible?

Ansible — это безагентная система управления конфигурациями, которая позволяет автоматизировать развертывание, настройку и управление инфраструктурой.

## Главное отличие Ansible

**Ansible — безагентная система.** Это означает, что **не требуется установка дополнительного ПО на клиентских машинах**. Взаимодействие происходит через SSH-соединение.

### Преимущества безагентного подхода:

1. **Простота развертывания** - не нужно устанавливать агенты на каждую машину
2. **Безопасность** - нет постоянно работающих агентов
3. **Легкость управления** - все управление с одного сервера
4. **Минимальные требования** - на клиентах достаточно Python и SSH

## Как работает Ansible?

Алгоритм работы Ansible:

1. **Сервер Ansible** (control node) соединяется с клиентами по сети через SSH
   - Информация о хостах берется из файла инвентаря (inventory)

2. **Отправка модулей** - сервер отправляет на клиенты небольшие программы (модули)
   - Каждый модуль решает одну конкретную задачу
   - Модули передаются по SSH и выполняются временно

3. **Выполнение на клиенте** - локальный интерпретатор Python на клиенте:
   - Генерирует исполняемый код на языке Python
   - Реализует поставленную задачу
   - Возвращает результат на сервер

4. **Очистка** - после завершения работы модули на клиентах автоматически удаляются

## Инфраструктура как код (IaC)

Ansible использует подход **Infrastructure as Code (IaC)**:

- **Желаемое состояние** инфраструктуры описывается программным кодом
- Используется **декларативный язык YAML** для понятного описания конфигурации
- Конфигурация хранится в **версионном контроле** (Git)
- **Централизованное управление** - все изменения в одном месте
- **Идемпотентность** - повторное выполнение дает тот же результат

### Преимущества IaC:

- ✅ Версионирование конфигураций
- ✅ Централизация управления
- ✅ Воспроизводимость
- ✅ Меньше ошибок при конфигурировании
- ✅ Документированность инфраструктуры

## Компоненты Ansible

### Playbook (плейбук)
YAML файлы, описывающие желаемое состояние системы. Содержат:
- Список хостов для управления
- Роли и задачи для выполнения
- Переменные и параметры

### Roles (роли)
Переиспользуемые наборы задач, организованные в структурированном виде:
- `tasks/` - задачи для выполнения
- `templates/` - шаблоны конфигурационных файлов
- `handlers/` - обработчики событий (например, перезапуск сервиса)
- `defaults/` - значения переменных по умолчанию
- `vars/` - переменные роли

### Inventory (инвентарь)
Файл со списком управляемых хостов, сгруппированных по категориям.

### Modules (модули)
Готовые программы для выполнения конкретных задач:
- `apt` - управление пакетами в Debian/Ubuntu
- `template` - генерация файлов из шаблонов
- `systemd` - управление systemd сервисами
- `copy` - копирование файлов
- И многие другие...

## Требования

### На сервере Ansible (control node):
- Ansible 2.9+
- Python 3.6+
- SSH клиент

### На клиентских машинах (managed nodes):
- **Python 3.6+** (обычно уже установлен в Ubuntu/Debian)
- **SSH сервер** (обычно уже установлен)
- Доступ по SSH с правами root или пользователя с sudo

**Важно:** Если Python отсутствует на клиенте, Ansible может установить его автоматически при первом подключении (требуется настройка в ansible.cfg).

## Пример работы

```bash
# 1. Ansible сервер подключается к клиенту по SSH
ssh root@192.168.1.10

# 2. Передает модуль для установки пакета
# Модуль apt временно копируется на клиент

# 3. Выполняется на клиенте через Python
python /tmp/ansible_apt_xxxxx.py

# 4. Результат возвращается на сервер
# Модуль удаляется с клиента

# 5. Ansible обрабатывает результат и продолжает выполнение
```

## Дополнительные ресурсы

- [Официальная документация Ansible](https://docs.ansible.com/)
- [Ansible Best Practices](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
- [Ansible Module Index](https://docs.ansible.com/ansible/latest/modules/modules_by_category.html)
