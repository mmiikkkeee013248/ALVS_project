---
- name: Инициализация Kubernetes master узла
  hosts: k8s_masters
  become: yes
  tasks:
    - name: Проверка, что kubeadm не инициализирован
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeconfig

    - name: Инициализация Kubernetes кластера
      shell: |
        kubeadm init \
          --pod-network-cidr={{ pod_network_cidr }} \
          --apiserver-advertise-address={{ k8s_master_ip }} \
          --control-plane-endpoint={{ k8s_master_ip }}:6443 \
          --service-cidr={{ service_cidr }} \
          --ignore-preflight-errors=Swap
      when: not kubeconfig.stat.exists
      register: kubeadm_init

    - name: Создание директории .kube для текущего пользователя
      file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Копирование kubeconfig для текущего пользователя
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/{{ ansible_user }}/.kube/config
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
        remote_src: yes
      when: kubeconfig.stat.exists or kubeadm_init.rc == 0

    - name: Ожидание готовности API сервера
      wait_for:
        host: "{{ k8s_master_ip }}"
        port: 6443
        delay: 10
        timeout: 300
      when: kubeconfig.stat.exists or kubeadm_init.rc == 0

    - name: Установка CNI плагина (Calico)
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      when: kubeconfig.stat.exists or kubeadm_init.rc == 0
      register: calico_install
      until: calico_install.rc == 0
      retries: 10
      delay: 15

    - name: Получение команды join для worker узлов
      shell: |
        kubeadm token create --print-join-command
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      register: join_command
      when: kubeconfig.stat.exists or kubeadm_init.rc == 0
      changed_when: false

    - name: Сохранение команды join в файл
      copy:
        content: "{{ join_command.stdout }}"
        dest: /tmp/kubeadm_join_command.sh
        mode: '0755'
      when: join_command.stdout is defined

    - name: Вывод команды join
      debug:
        msg: "Команда для присоединения worker узлов: {{ join_command.stdout }}"
