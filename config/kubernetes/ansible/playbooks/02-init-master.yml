---
- name: Инициализация Kubernetes master узла
  hosts: k8s_masters
  become: yes
  tasks:
    - name: Полный сброс перед инициализацией
      shell: kubeadm reset -f && rm -rf /etc/cni/net.d && rm -rf $HOME/.kube
      ignore_errors: yes

    - name: Инициализация Kubernetes кластера
      shell: |
        kubeadm init \
          --pod-network-cidr={{ pod_network_cidr }} \
          --apiserver-advertise-address={{ k8s_master_ip }} \
          --ignore-preflight-errors=Swap
      register: kubeadm_init

    - name: Создание директории .kube
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Копирование kubeconfig
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
        remote_src: yes

    - name: Ожидание API сервера
      wait_for:
        host: "{{ k8s_master_ip }}"
        port: 6443
        delay: 5
        timeout: 300

    - name: Установка Flannel CNI
      shell: |
        kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      environment:
        KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

    - name: Тюнинг API сервера (Таймауты и Лимиты)
      shell: |
        sed -i '/--service-cluster-ip-range/a \    - --max-requests-inflight=400\n    - --max-mutating-requests-inflight=200\n    - --feature-gates=APIPriorityAndFairness=false' /etc/kubernetes/manifests/kube-apiserver.yaml
        sed -i 's/initialDelaySeconds: 15/initialDelaySeconds: 60/g' /etc/kubernetes/manifests/kube-apiserver.yaml
        sed -i 's/timeoutSeconds: 15/timeoutSeconds: 30/g' /etc/kubernetes/manifests/kube-apiserver.yaml

    - name: Тюнинг etcd (Таймауты для слабого железа)
      shell: |
        sed -i '/--initial-cluster-state=new/a \    - --heartbeat-interval=250\n    - --election-timeout=1250' /etc/kubernetes/manifests/etcd.yaml
        sed -i 's/initialDelaySeconds: 15/initialDelaySeconds: 60/g' /etc/kubernetes/manifests/etcd.yaml

    - name: Получение команды join
      shell: kubeadm token create --print-join-command
      register: join_command_raw

    - name: Сохранение команды join
      set_fact:
        join_command: "{{ join_command_raw.stdout }}"
