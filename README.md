# Приложение для управления контактами

Веб-приложение на Flask для управления контактами с использованием PostgreSQL в качестве базы данных.

## Возможности

- **Web-интерфейс** на Flask для управления контактами
- **База данных PostgreSQL** для хранения данных
- **Валидация email** при добавлении и редактировании контактов
- **Обработка ошибок** с информативными сообщениями для пользователя
- **Система логирования** всех операций (добавление, редактирование, удаление)
- **Автоматическое тестирование** через pytest
- **CI/CD конвейер** на GitHub Actions с проверкой кода и автотестами

## Файлы проекта

### Основные файлы приложения

- **`web_app.py`** – веб-приложение на Flask с маршрутами для CRUD операций
- **`db.py`** – модуль для подключения к PostgreSQL и работы с таблицей `contacts`
- **`logger.py`** – модуль настройки логирования с ротацией файлов
- **`templates/index.html`** – HTML-шаблон для веб-интерфейса
- **`app.py`** – десктопное GUI-приложение на tkinter (опционально)

### Тестирование

- **`tests/test_web_app.py`** – pytest-тесты web-части (с заглушкой БД, 4 теста)
- **`tests/test_db.py`** – pytest-тесты для работы с реальной PostgreSQL БД (4 теста)

### Конфигурация

- **`requirements.txt`** – зависимости Python проекта
- **`.gitignore`** – файлы и директории, игнорируемые Git
- **`.github/workflows/ci.yml`** – конфигурация CI/CD конвейера на GitHub Actions

## Настройка окружения

### 1. Установка Python и зависимостей

Убедитесь, что установлен Python 3.10 или выше. Затем установите зависимости:

```bash
pip install -r requirements.txt
```

### 2. Установка и настройка PostgreSQL

1. Установите PostgreSQL на вашу систему
2. Создайте базу данных (например, `test_db`):
   ```sql
   CREATE DATABASE test_db;
   ```
3. Создайте пользователя и выдайте ему права на базу, либо используйте существующего `postgres`

### 3. Настройка подключения к БД

Подключение настраивается через переменные окружения. В PowerShell:

```powershell
$env:PG_HOST="localhost"
$env:PG_PORT="5432"
$env:PG_DB="test_db"
$env:PG_USER="postgres"
$env:PG_PASSWORD="ваш_пароль"
```

В Linux/Mac (bash):

```bash
export PG_HOST="localhost"
export PG_PORT="5432"
export PG_DB="test_db"
export PG_USER="postgres"
export PG_PASSWORD="ваш_пароль"
```

Или создайте файл `.env` в корне проекта:

```env
PG_HOST=localhost
PG_PORT=5432
PG_DB=test_db
PG_USER=postgres
PG_PASSWORD=ваш_пароль
```

**Значения по умолчанию** (если переменные не заданы):
- хост: `localhost`
- порт: `5432`
- база: `test_db`
- пользователь: `postgres`
- пароль: `postgres`

## Запуск приложения

### Запуск веб-приложения

В каталоге проекта выполните:

```bash
python web_app.py
```

При первом запуске автоматически создаётся таблица `contacts` (если её ещё нет).

По умолчанию приложение будет доступно в браузере по адресу:

```
http://127.0.0.1:5000/
```

### Функциональность веб-интерфейса

На странице можно:
- **просматривать** список всех контактов
- **добавлять** новый контакт (с валидацией email)
- **редактировать** существующие контакты (с валидацией email)
- **удалять** контакты

Все операции логируются в файл `app.log` и выводятся в консоль.

### Запуск GUI-приложения (опционально)

Для запуска десктопного приложения на tkinter:

```bash
python app.py
```

## Тестирование

### Запуск тестов

Для запуска всех тестов:

```bash
pytest
```

Для запуска только тестов веб-приложения (без реальной БД):

```bash
pytest tests/test_web_app.py -v
```

Для запуска тестов работы с БД (требует настроенной PostgreSQL):

```bash
pytest tests/test_db.py -v
```

### Покрытие тестами

- **test_web_app.py**: 4 теста (проверка рендеринга страницы, добавление, редактирование, удаление контактов)
- **test_db.py**: 4 теста (инициализация БД, добавление, обновление, удаление контактов)

## CI/CD

Проект настроен с автоматическим CI/CD конвейером на GitHub Actions. При каждом push в ветку `main` или создании pull request автоматически:

1. Проверяется код на соответствие стандартам (flake8)
2. Запускаются автотесты (pytest)

Статус выполнения можно посмотреть во вкладке **Actions** на GitHub.

## Архитектура и описание работы компонентов

### Общая архитектура

Приложение построено по принципу разделения ответственности:

```
┌─────────────┐
│  web_app.py │  ← Веб-слой (Flask маршруты, валидация, обработка запросов)
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   db.py     │  ← Слой работы с БД (подключение, CRUD операции)
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ PostgreSQL  │  ← База данных
└─────────────┘

┌─────────────┐
│ logger.py   │  ← Система логирования (используется везде)
└─────────────┘
```

### Описание компонентов

#### 1. `web_app.py` - Веб-приложение Flask

**Назначение**: Обработка HTTP-запросов, валидация данных, взаимодействие с пользователем.

**Основные компоненты**:

- **`create_app()`** - Фабрика приложения Flask. Создаёт экземпляр приложения и настраивает маршруты. Используется для удобного тестирования.

- **`@app.before_request`** - Декоратор, который выполняется перед каждым запросом. Инициализирует БД при первом запросе (создаёт таблицу `contacts`, если её нет).

- **Маршруты**:
  - **`GET /`** - Главная страница. Загружает все контакты из БД и отображает их в таблице.
  - **`POST /add`** - Добавление нового контакта. Валидирует email, обрабатывает ошибки, логирует операцию.
  - **`POST /edit/<contact_id>`** - Редактирование существующего контакта. Валидирует email, обновляет данные в БД, логирует операцию.
  - **`POST /delete/<contact_id>`** - Удаление контакта. Удаляет запись из БД, логирует операцию.

- **`validate_email()`** - Функция валидации email адреса с использованием регулярных выражений. Проверяет формат адреса перед сохранением в БД.

**Обработка ошибок**: Все операции обёрнуты в `try-except` блоки. При ошибках пользователю показываются информативные сообщения через систему flash-сообщений Flask.

#### 2. `db.py` - Модуль работы с базой данных

**Назначение**: Абстракция для работы с PostgreSQL. Предоставляет функции для подключения и выполнения операций с БД.

**Основные компоненты**:

- **`get_db_config()`** - Читает настройки подключения из переменных окружения (PG_HOST, PG_PORT, PG_DB, PG_USER, PG_PASSWORD) или использует значения по умолчанию.

- **`get_connection()`** - Context manager для работы с подключением к БД. Автоматически закрывает соединение после использования. Использует `RealDictCursor` для получения результатов в виде словарей.

- **`init_db()`** - Создаёт таблицу `contacts` с полями:
  - `id` (SERIAL PRIMARY KEY) - автоинкрементный идентификатор
  - `name` (TEXT NOT NULL) - имя контакта
  - `email` (TEXT NOT NULL) - email адрес

- **CRUD функции**:
  - **`get_all_contacts()`** - Получает все контакты из БД, отсортированные по ID
  - **`add_contact(name, email)`** - Добавляет новый контакт в БД
  - **`update_contact(contact_id, name, email)`** - Обновляет данные существующего контакта
  - **`delete_contact(contact_id)`** - Удаляет контакт по ID

**Безопасность**: Все SQL-запросы используют параметризованные запросы (`%s`), что защищает от SQL-инъекций.

#### 3. `logger.py` - Система логирования

**Назначение**: Централизованная настройка логирования для всего приложения.

**Основные компоненты**:

- **`setup_logger()`** - Настраивает логгер с двумя обработчиками:
  - **FileHandler** с ротацией файлов (максимум 5 МБ на файл, 3 резервные копии). Логи сохраняются в `app.log`.
  - **StreamHandler** для вывода логов в консоль.

- **Формат логов**: `YYYY-MM-DD HH:MM:SS - logger_name - LEVEL - message`

- **`app_logger`** - Глобальный экземпляр логгера, используемый во всём приложении.

**Что логируется**:
- Загрузка контактов (количество загруженных записей)
- Добавление контакта (имя, email)
- Обновление контакта (ID, имя, email)
- Удаление контакта (ID)
- Ошибки при выполнении операций

#### 4. `templates/index.html` - HTML-шаблон

**Назначение**: Пользовательский интерфейс для работы с контактами.

**Структура**:
- Таблица со списком всех контактов
- Форма для добавления нового контакта
- Инлайн-формы для редактирования каждого контакта прямо в таблице
- Кнопки удаления с подтверждением
- Отображение flash-сообщений (успех/ошибка)

**Особенности**:
- Адаптивный дизайн (работает на мобильных устройствах)
- Валидация на стороне клиента (required поля, type="email")
- Подтверждение перед удалением (JavaScript confirm)

#### 5. Тесты

**`tests/test_web_app.py`**:
- Использует заглушку БД (`DummyDB`) для тестирования без реальной PostgreSQL
- Тестирует все маршруты и операции CRUD
- Проверяет корректность обработки данных и отображения страниц

**`tests/test_db.py`**:
- Тестирует функции работы с реальной БД
- Требует настроенной PostgreSQL
- Проверяет все CRUD операции на реальных данных

#### 6. CI/CD конвейер (`.github/workflows/ci.yml`)

**Назначение**: Автоматическая проверка кода и запуск тестов при каждом push.

**Этапы**:
1. **Checkout code** - Получение кода из репозитория
2. **Set up Python** - Установка Python 3.12
3. **Install dependencies** - Установка зависимостей из `requirements.txt`
4. **Lint with flake8** - Проверка кода на соответствие стандартам PEP 8
5. **Run tests** - Запуск автотестов через pytest

**Триггеры**: Запускается при push в ветки `main` или `feature/*`, а также при создании pull request.

### Поток данных при добавлении контакта

```
1. Пользователь заполняет форму на / → POST /add
2. web_app.py получает данные (name, email)
3. Валидация email через validate_email()
4. Если валидация успешна → db.add_contact(name, email)
5. db.py открывает соединение с PostgreSQL
6. Выполняется INSERT запрос
7. Логирование операции через app_logger.info()
8. Flash-сообщение об успехе
9. Редирект на главную страницу
10. GET / загружает обновлённый список контактов
11. Отображение нового контакта в таблице
```

### Обработка ошибок

Все операции с БД обёрнуты в `try-except` блоки:
- При ошибке подключения к БД → flash-сообщение об ошибке
- При ошибке валидации → flash-сообщение о некорректных данных
- Все ошибки логируются через `app_logger.error()` с деталями
- Пользователь всегда получает информативное сообщение

### Безопасность

- **Параметризованные SQL-запросы** - защита от SQL-инъекций
- **Валидация входных данных** - проверка формата email перед сохранением
- **Обработка исключений** - предотвращение утечки информации об ошибках БД

---

## Лицензия

Проект создан в учебных целях.